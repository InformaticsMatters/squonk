# Deploys PostgreSQL with the RDKit cartridge plus the chemical search service.
#
# oc process -f chemcentral.yaml | oc create -f -
# oc delete all,cm,pvc,secrets --selector template=chemcentral

kind: Template
apiVersion: v1
metadata:
  name: chemcentral
  annotations:
    description: Chemcentral chemical search
    tags: squonk,chemcentral
labels:
  template: chemcentral
  app: chemcentral

parameters:

- name: POSTGRES_IMAGE_TAG
  description: The version tag for the RDKIT container version
  value: Release_2017_09_1

- name: POSTGRES_SERVICE
  displayName: PostgreSQL RDKit cartridge service name
  value: postgresql-rdkit-cartridge

- name: POSTGRES_ADMIN_USER
  displayName: Database admin username
  value: postgres

- name: POSTGRES_ADMIN_PASSWORD
  displayName: Database Admin Password
  from: "[a-zA-Z0-9]{8}"
  generate: expression
  required: true

- name: POSTGRES_CHEMCENTRAL_PASSWORD
  displayName: Database User Password
  from: "[a-zA-Z0-9]{8}"
  generate: expression
  required: true

- name: POSTGRES_CPU_REQUEST
  value: 100m
- name: POSTGRES_CPU_LIMIT
  value: 1000m
- name: POSTGRES_MEM_REQUEST
  value: 100Mi
- name: POSTGRES_MEM_LIMIT
  value: 500Mi

- name: SEARCH_IMAGE_TAG
  value: openshift

- name: SEARCH_STRUCTURE_DATABASE_TABLES
  description: Chemical search tables
  value: ""


objects:

- kind: Secret
  apiVersion: v1
  metadata:
    name: chemcentral-database-credentials
  stringData:
    database-name: chemcentral
    database-admin-user: postgres
    database-admin-password: "${POSTGRES_ADMIN_PASSWORD}"
    database-user: chemcentral
    database-password: "${POSTGRES_CHEMCENTRAL_PASSWORD}"

# -----------------------------------------------------------------------------
# Postgres Service
# -----------------------------------------------------------------------------


- kind: ConfigMap
  apiVersion: v1
  metadata:
    name: chemcentral-init-map
  data:
    init-postgres-db.sh: |
      #!/bin/bash

      export PGUSER=${POSTGRESQL_ADMIN_USER:-postgres}
      export PGPASSWORD=${POSTGRESQL_ADMIN_PASSWORD}

      echo "Setting up db as user ${PGUSER}"

      echo "Creating chemcentral user"
      psql --command "CREATE USER chemcentral WITH PASSWORD '${POSTGRES_CHEMCENTRAL_PASSWORD:-chemcentral}';"
      echo "Chemcentral user created with password ${POSTGRES_CHEMCENTRAL_PASSWORD:-chemcentral}"

      echo "Creating chemcentral database"
      createdb -O chemcentral chemcentral
      echo "Chemcentral database created"

      echo "Deploying RDKit cartridge to chemcentral"
      psql --command 'create extension rdkit' chemcentral
      echo "RDKit cartridge deployed to chemcentral"

      echo "Creating vendordbs schema in chemcentral"
      psql -d chemcentral --command "CREATE SCHEMA vendordbs AUTHORIZATION chemcentral;"
      echo "vendordbs schema created"

- kind: DeploymentConfig
  apiVersion: v1
  metadata:
    name: ${POSTGRES_SERVICE}
  spec:
    replicas: 1
    selector:
      name: ${POSTGRES_SERVICE}
    template:
      metadata:
        labels:
          name: ${POSTGRES_SERVICE}
      spec:
        containers:
        - image: informaticsmatters/rdkit_cartridge:${POSTGRES_IMAGE_TAG}
          name: ${POSTGRES_SERVICE}
          securityContext:
            runAsUser: 999
          env:
          - name: POSTGRES_USER
            value: postgres
          - name: POSTGRES_PASSWORD
            value: "${POSTGRES_ADMIN_PASSWORD}"
          - name: POSTGRES_CHEMCENTRAL_PASSWORD
            value: "${POSTGRES_CHEMCENTRAL_PASSWORD}"
          ports:
          - containerPort: 5432
          readinessProbe:
            exec:
              command: ['sh', '-c',
                'select=$(echo SELECT 1 | psql --host 127.0.0.1 --username postgres --quiet --no-align --tuples-only) && [ $select = 1 ]']
            initialDelaySeconds: 15
            timeoutSeconds: 5
          livenessProbe:
            # This probe results in PG issuing 'incomplete startup packet'
            # messages to the log. They're the result of probe
            # making a TCP connection but sending no traffic.
            initialDelaySeconds: 60
            tcpSocket:
              port: 5432
            timeoutSeconds: 1
            # Default period is 10 seconds
            periodSeconds: 20
#          resources:
#            limits:
#              cpu: ${POSTGRES_CPU_LIMIT}
#              memory: ${POSTGRES_MEM_LIMIT}
#            requests:
#              cpu: ${POSTGRES_CPU_REQUEST}
#              memory: ${POSTGRES_MEM_REQUEST}
          terminationMessagePath: /dev/termination-log
          volumeMounts:
          - mountPath: /var/lib/postgresql/data
            name: postgresql-data
          - mountPath: /docker-entrypoint-initdb.d
            name: init-config
        volumes:
        - name: postgresql-data
          persistentVolumeClaim:
            claimName: chemcentral-postgresql-claim
        - name: init-config
          configMap:
            name: chemcentral-init-map

- kind: Service
  apiVersion: v1
  metadata:
    name: ${POSTGRES_SERVICE}
  spec:
    ports:
    - name: ${POSTGRES_SERVICE}
      port: 5432
      targetPort: 5432
    selector:
      name: ${POSTGRES_SERVICE}

# -----------------------------------------------------------------------------
# Chemcentral search
# -----------------------------------------------------------------------------

- kind: DeploymentConfig
  apiVersion: v1
  metadata:
    name: chemcentral-search
  spec:
    replicas: 1
    selector:
      name: chemcentral-search
    template:
      metadata:
        labels:
          name: chemcentral-search
      spec:
        containers:
        - image: squonk/chemcentral-search:${SEARCH_IMAGE_TAG}
          name: chemcentral-search
          env:
          - name: POSTGRES_HOSTNAME
            value: ${POSTGRES_SERVICE}
          - name: POSTGRES_CHEMCENTRAL_USER
            valueFrom:
              secretKeyRef:
                name: chemcentral-database-credentials
                key: database-user
          - name: POSTGRES_CHEMCENTRAL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: chemcentral-database-credentials
                key: database-password
          - name: RABBITMQ_HOSTNAME
            valueFrom:
              secretKeyRef:
                name: squonk-rabbitmq-credentials
                key: host
          - name: RABBITMQ_SQUONK_PASSWORD
            valueFrom:
              secretKeyRef:
                name: squonk-rabbitmq-credentials
                key: pass
          - name: STRUCTURE_DATABASE_TABLES
            value: ${SEARCH_STRUCTURE_DATABASE_TABLES}
          ports:
          - containerPort: 8080
          readinessProbe:
            httpGet:
              path: /chemcentral-search/rest/ping
              port: 8080
            initialDelaySeconds: 60
            timeoutSeconds: 1
            periodSeconds: 20
          livenessProbe:
            httpGet:
              path: /chemcentral-search/rest/ping
              port: 8080
            initialDelaySeconds: 30
            timeoutSeconds: 1
            periodSeconds: 30

- kind: Service
  apiVersion: v1
  metadata:
    name: chemcentral-search
  spec:
    ports:
    - name: http
      port: 8080
      targetPort: 8080
    selector:
      name: chemcentral-search
