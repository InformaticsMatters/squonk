#!/usr/bin/env bash

echo "=-> Assembling..."
if [ -d /tmp/artifacts/cache ]; then
    echo "=-> Restoring cache directory from incremental build."
    mkdir -p ${HOME}/.gradle
    cp -r /tmp/artifacts/cache/caches ${HOME}/.gradle
fi

# Build the application and its artifacts.
# S2I places the root of the 'source'
# (the squonk git repo in our case)
# in /tmp/src
echo "=-> Building..."
pushd ${HOME}
cd /tmp/src/components
gradle build chemServicesWars --build-cache --no-daemon -x test
popd

# For incremental builds we move key build files
# to the /home/squonk/cache directory
#
# Inspired by the notes relating to travis builds at...
#   https://guides.gradle.org/executing-gradle-builds-on-travisci
echo "=-> Cleaning artifacts..."
rm -f  ${HOME}/.gradle/caches/modules-2/modules-2.lock
rm -rf ${HOME}/.gradle/caches/*/plugin-resolution/

echo "=-> Copying artifacts to cache..."
mkdir -p /tmp/cache
cp -r ${HOME}/.gradle/caches /tmp/cache/caches
ls -la /tmp/cache

echo "=-> Assembled"
