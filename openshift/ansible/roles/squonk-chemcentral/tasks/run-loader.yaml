---

- name: Login (user)
  command: oc login {{ oc_master_url }} -u {{ oc_user }} -p {{ oc_user_password }}
  changed_when: False

- name: Move to Squonk Project
  command: oc project {{ oc_cc_project }}
  changed_when: False

# Load data into the ChemCentral database.
# This is achieved by launching the loader Job
# which relies on the file in the loader's PVC.
#
# The loader Job can take considerable time
# so the rest is up to you...

- name: Check Jobs
  command: oc get jobs
  register: jobs_result
  changed_when: False

# The loader 'flavour' is dependent on the
# class of loader that's expected.
# Only one of the the following should run
# (but it will only run if loader job does not exist).
#
# Loaders are distinguished by their markers.
# A loader can run as long as there isn't one
# with the same marker.
#
# Use the 'delete-loader' playbook to remove running or
# completed jobs.

- name: Create Loader Job (Single File)
  shell: >
    oc process
    -f {{ role_path }}/files/loader.yaml
    -p APP_NAMESPACE={{ oc_cc_project }}
    -p APP_SA={{ oc_cc_infra_sa }}
    -p LOADER_CLASS=org.squonk.rdkit.db.loaders.{{ oc_cc_loader_class }}
    -p LOADER_FILE={{ oc_cc_loader_file }}
    -p LOADER_MARKER={{ oc_cc_loader_marker }}
    -p LIMIT={{ oc_cc_loader_limit }}
    | oc create -f -
  when:
  - oc_cc_loader_class in ['EnamineRealDsiLoader', 'EMoleculesBBSmilesLoader']
  - not jobs_result.stdout|regex_search('^chemcentral-loader-%s\s' % oc_cc_loader_marker, multiline=True)

- name: Create Loader Job (Multiple Files)
  shell: >
    oc process
    -f {{ role_path }}/files/loader.yaml
    -p APP_NAMESPACE={{ oc_cc_project }}
    -p APP_SA={{ oc_cc_infra_sa }}
    -p LOADER_CLASS=org.squonk.rdkit.db.loaders.{{ oc_cc_loader_class }}
    -p LOADER_DIR={{ oc_cc_loader_dir }}
    -p LOADER_PATTERN={{ oc_cc_loader_pattern }}
    -p LOADER_MARKER={{ oc_cc_loader_marker }}
    -p LIMIT={{ oc_cc_loader_limit }}
    -p CCL_CPU_REQUEST={{ oc_cc_loader_cpu_request }}
    -p CCL_MEM_REQUEST={{ oc_cc_loader_mem_request }}
    | oc create -f -
  when:
  - oc_cc_loader_class in ['MolportSmilesLoader']
  - not jobs_result.stdout|regex_search('^chemcentral-loader-%s\s' % oc_cc_loader_marker, multiline=True)
