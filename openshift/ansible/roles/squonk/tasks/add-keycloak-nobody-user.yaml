---

# Get a keycloak token (sets the fact 'keycloak_token').
# Remember that the login user may have changed to admin.
#
#Â The actions for getting the KeyCloak token
# are located in a infra role playbook.

- include_tasks: >
    "{{ role_path }}/../infra/tasks/get-keycloak-token.yaml"
  tags:
  - keycloak-users

# Note: See the 'add-keycloak-users' playbook
#       for a basic description
#       of the steps that follow...

- name: Define the 'nobody' user (and assign a password)
  set_fact:
    user_name: nobody
    user_password: "{{ lookup('password', '/dev/null length=15 chars=ascii_letters') }}"
  tags:
  - keycloak-users

- name: Query existing Squonk Users
  uri:
    url: "{{ keycloak_server_url }}/admin/realms/{{ keycloak_realm }}/users?username={{ user_name }}"
    validate_certs: no
    headers:
      Authorization: bearer {{ keycloak_token }}
  register: user_check
  changed_when: False
  tags:
  - keycloak-users

- name: Expose 'nobody' password
  debug:
    msg: User {{ user_name }} has password {{ user_password }}
  when:
  - not user_check | json_query('json')

- name: Add 'nobody' (if it does not exist)
  uri:
    url: "{{ keycloak_server_url }}/admin/realms/{{ keycloak_realm }}/users"
    method: POST
    body: >-
      {"username": "{{ user_name }}",
       "enabled": "true"}
    body_format: json
    status_code: 201
    validate_certs: no
    headers:
      Authorization: bearer {{ keycloak_token }}
  when:
  - not user_check | json_query('json')
  tags:
  - keycloak-users

- name: Query 'nobody' user (to get its assigned identity)
  uri:
    url: "{{ keycloak_server_url }}/admin/realms/{{ keycloak_realm }}/users?username={{ user_name }}"
    validate_certs: no
    headers:
      Authorization: bearer {{ keycloak_token }}
  register: nobody_user
  when:
  - not user_check | json_query('json')
  tags:
  - keycloak-users

- name: Get 'nobody' User Identity
  set_fact:
    nobody_user_id: "{{ nobody_user | json_query('json[0].id') }}"
  when:
  - not user_check | json_query('json')
  tags:
  - keycloak-users

- name: Set (Reset) Keycloak 'nobody' User Password
  uri:
    url: "{{ keycloak_server_url }}/admin/realms/{{ keycloak_realm }}/users/{{ nobody_user_id }}/reset-password"
    method: PUT
    body: >-
      {"type": "password",
       "temporary": "false",
       "value": "{{ user_password }}"}
    body_format: json
    status_code: 204
    validate_certs: no
    headers:
      Authorization: bearer {{ keycloak_token }}
  when:
  - not user_check | json_query('json')
  tags:
  - keycloak-users
