---

# Variables that control this set of tasks are: -
#
# - oc_keycloak_server_url              The Keycloak server authentication URL
#                                       typically 'https://sso.example.org/auth'
# - oc_keycloak_realm                   The Keycloak realm the user's in
# - oc_keycloak_api_secrets             The name of the secrets the password's in
# - oc_keycloak_api_user                The name of the Keycloak REST API user
# - oc_keycloak_api_user_password_field The name of the users' password field
#                                       in the secrets

# -----------------------------------------------------------------------------

# This play sets two facts:
#
# - keycloak_api_password
# - keycloak_token
#
# The token is valid for a limited time
# defined by the Keycloak installation.

# We need to be admin

- name: Login (admin)
  shell: >
    oc login {{ oc_master_url }} -u {{ oc_admin }} -p {{ oc_admin_password }}
    --insecure-skip-tls-verify=true
  changed_when: False
  tags:
    - keycloak-users

# Get some secrets from the infrastructure...

- name: Get Keycloak API User's Password ({{ oc_keycloak_api_user_password_field }})
  shell: >
    oc get secret {{ oc_keycloak_api_secrets }} -n {{ oc_infra_project }} -o yaml
    | grep {{ oc_keycloak_api_user_password_field }}
  register: secret_result
  changed_when: False
  tags:
    - keycloak-users

- name: Set Keycloak API User Password Fact
  set_fact:
    keycloak_api_password: "{{ secret_result.stdout|regex_replace(regexp, '\\1')|b64decode }}"
  vars:
    regexp: '^\s+{{ oc_keycloak_api_user_password_field }}:\s+(\S+)\s*$'
  changed_when: False
  tags:
    - keycloak-users

# Now get the API token.
# There's a time-limit using this.

- name: Display API token credentials
  debug:
    msg: username={{ oc_keycloak_api_user }} password={{ keycloak_api_password }}

- name: Get Keycloak API Token ({{ oc_keycloak_realm }} realm)
  uri:
    url: "{{ oc_keycloak_server_url }}/realms/{{ oc_keycloak_realm }}/protocol/openid-connect/token"
    method: POST
    body: "{{ credentials }}&grant_type=password&client_id=admin-cli"
    headers:
      Content-Type: "application/x-www-form-urlencoded"
    validate_certs: "{{ oc_validate_certificates }}"
  register: token_result
  vars:
    credentials: "username={{ oc_keycloak_api_user }}&password={{ keycloak_api_password }}"
  changed_when: False
  tags:
    - keycloak-users

- name: Set Keycloak API Token Fact
  set_fact:
    keycloak_token: "{{ token_result.json.access_token }}"
  changed_when: False
  tags:
    - keycloak-users
