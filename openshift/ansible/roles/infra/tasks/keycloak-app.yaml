---

- name: Move to Infrastructure Project
  shell: oc project {{ oc_infra_project }}
  changed_when: False

- name: Login (user)
  shell: >
    oc login {{ oc_master_url }} -u {{ oc_user }} -p {{ oc_user_password }}
    --insecure-skip-tls-verify=true
  changed_when: False

- name: Check Keycloak Deployment
  shell: oc get dc
  register: dc_result
  changed_when: False

- name: Create Keycloak Deployment
  shell: >
    oc process
    -f {{ role_path }}/files/keycloak.yaml
    -p APPLICATION_NAME={{ oc_infra_keycloak_app_name }}
    -p SERVICE_NAME={{ oc_infra_keycloak_svc_name }}
    -p KEYCLOAK_SA={{ oc_infra_sa }}
    -p KEYCLOAK_CPU_REQUEST={{ oc_infra_keycloak_cpu_request }}
    -p KEYCLOAK_MEM_REQUEST={{ oc_infra_keycloak_mem_request }}
    -p KEYCLOAK_CPU_LIMIT={{ oc_infra_keycloak_cpu_limit }}
    -p KEYCLOAK_MEM_LIMIT={{ oc_infra_keycloak_mem_limit }}
    | oc create -f -
  when: oc_infra_keycloak_app_name not in dc_result.stdout

# Wait for running pods

- name: Wait for Pods
  shell: oc get po | grep {{ item }} | grep -v deploy | grep 1/1 > /dev/null
  delay: 20
  retries: "{{ (oc_pod_ready_timeout | int / 20) | int }}"
  register: result
  until: result.rc == 0
  when: oc_wait_for_pods|bool
  loop:
  - keycloak
  changed_when: False

# SSO may not be completely ready for the next step (add-keycloak-roles)
# so we pause here (on first execution) for a few seconds.

- name: Post deploy pause
  pause:
    seconds: 10
  when:
  - oc_wait_for_pods|bool
  - oc_infra_keycloak_app_name not in dc_result.stdout
