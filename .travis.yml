---

# The Squonk Travis CI build script.
#
# For Gradle build hints checkout the following: -
#   https://guides.gradle.org/executing-gradle-builds-on-travisci
#   https://docs.travis-ci.com/user/languages/java/

os: linux
language: java
jdk: openjdk8

services:
- docker

stages:

  # The 'compile' stage
  # - Compiles the code (a quick initial stage).
- name: compile

  # The 'test' stage
  # - Compiles the code and also runs unit tests.
- name: test

  # The 'docker' stage
  # - Assembles docker images to verify that they can be constructed.
  #   It does not push these images - it's simply an assembly-check.
  #   We do this if we're not the result of a tag and we're not on master.
- name: docker
  if: tag IS NOT present AND branch != master

  # The 'publish' stage
  # - Assembles docker images and pushes the resultant images to Docker Hub.
  #   We execute the 'publish' stage and always publish an image
  #   on master or when tagged. When tagged the tag value is used for the
  #   image tag, when not tagged the published image tag is 'latest'.
- name: publish
  if: tag IS present OR branch == master

install:
- pushd "$TRAVIS_BUILD_DIR"/components
- ./gradlew installChemaxonLicenseToHome
- ./gradlew installChemaxonLibrary
- popd

before_cache:
- rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
  - $HOME/.gradle/caches/
  - $HOME/.gradle/wrapper/

jobs:
  include:

  # Compile-stage jobs...

  - stage: compile
    name: Compile
    script: scripts/compile.sh

  # Test-stage jobs...

  - stage: test
    name: Unit Test
    script: scripts/test.sh

  # Docker-stage jobs...

  - stage: docker
    name: Docker Build
    script: scripts/docker.sh

  # Publish-stage jobs...

  - stage: publish
    name: Docker Build and Push (master/latest)
    script: scripts/publish-latest.sh
    if: tag IS NOT present AND branch == master

  - stage: publish
    name: Docker Build and Push (master/tag)
    script: scripts/publish-tag-master.sh
    if: tag IS present AND branch == master

  - stage: publish
    name: Docker Build and Push (branch/tag)
    script: scripts/publish-tag-branch.sh
    if: tag IS present AND branch != master
