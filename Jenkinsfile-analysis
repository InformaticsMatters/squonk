#!groovy

// Part of the Squonk/OepnShift CI/CD Jenkins Pipeline.
//
// This file is used to construct peripheral build jobs relating to things
// like static analysis (FindBugs) and code coverage (JaCoCo). This job
// normally runs after successful completion of the pipeline actions
// defined in the _core_ `Jenkinsfile`.
//
// Refer to the main Jenkinsfile for additional documentation.

pipeline {

    // As we need different flavours of agent,
    // the agent definition is deferred to each stage.
    agent none

    environment {
        ORG_GRADLE_PROJECT_cxnMavenUser = credentials('cxnMavenUser')
        ORG_GRADLE_PROJECT_cxnMavenPassword = credentials('cxnMavenPassword')
    }

    stages {

        // --------------------------------------------------------------------
        // Analysis stages
        // --------------------------------------------------------------------
        stage ('Analysis') {
            parallel {

                // Static analysis (FindBugs)
                stage('Static Analyis') {

                    // The assemble step is designed for jobs that execute rapidly.
                    // This is not about testing or Docker,
                    // This step is just about making sure the code compiles.
                    agent {
                        label 'maven'
                    }

                    steps {
                        dir('components') {

                            // Run FindBugs on the code...
                            sh './gradlew findbugsMain --no-daemon'

                            // Analyse and present the results...
                            findbugs canComputeNew: false,
                                isRankActivated: true,
                                pattern: '**/findbugsReports/main.xml'

                        }
                    }

                }

                // Unit test the code
                stage('Code Coverage') {

                    // The unit-test stage.
                    // Here we require the services of Docker for some tests
                    // so the built-in `maven` agent is not enough.
                    // For now we defer to AWS until we have a Docker build
                    // solution from within OpenShift.
                    agent {
                        label 'maven'
                    }

                    environment {
                        CPSIGN_MODEL_DIR = "${env.WORKSPACE}/tmp/cpsign"
                        CPSIGN_LICENSE_URL = "${env.WORKSPACE}/data/licenses/cpsign0.3pro.license"
                        SQUONK_DOCKER_WORK_DIR = "${env.WORKSPACE}/tmp"
                        SQUONK_NEXTFLOW_WORK_DIR = "${env.WORKSPACE}/tmp"
                    }

                    steps {
                        // Prepare the sub-projects
                        sh 'git submodule update --recursive --remote --init'
                        // Move pipleines project data to Squonk...
                        dir('pipelines') {
                            sh './copy.dirs.sh'
                        }
                        // Squonk...
                        dir('components') {
                            withCredentials([file(credentialsId: 'cpSignLicense', variable: 'CP_FILE'),
                                             file(credentialsId: 'chemAxonLicense', variable: 'CX_FILE'),
                                             file(credentialsId: 'chemAxonReactionLibrary', variable: 'CX_LIB')]) {

                                sh 'chmod u+w $CP_FILE'
                                sh 'chmod u+w $CX_FILE'
                                sh 'chmod u+w $CX_LIB'
                                sh 'mkdir -p ../data/licenses'
                                sh 'mkdir -p ../tmp/cpsign'
                                sh 'mkdir -p ~/.chemaxon'
                                sh 'mv -n $CP_FILE ../data/licenses'
                                sh 'cp -n $CX_FILE ~/.chemaxon'
                                sh 'mv -n $CX_FILE ../data/licenses'
                                sh 'mv -n $CX_LIB ../docker/deploy/images/chemservices'

                                // Run tests using code-coverage
                                sh './gradlew test jacocoTestReport --no-daemon'

                                // Analyse and present the results...
                                jacoco sourcePattern: '**/src/main/groovy'

                            }
                        }
                    }

                }

            }
        }

    }

    post {
        failure {
            mail to: 'achristie@informaticsmatters.com tdudgeon@informaticsmatters.com',
            subject: "Failed Analysis Pipeline",
            body: "Something is wrong with ${env.BUILD_URL}"
        }
    }

}
